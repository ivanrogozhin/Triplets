select *
from  
(select count(REPORTS.ID), TO_CHAR(REPORTS.DAT, 'YYYY')as y
from REPORTS
group by TO_CHAR(REPORTS.DAT, 'YYYY')
order by count(REPORTS.ID) desc)
where ROWNUM <= 1

select TO_CHAR(REPORTS.DAT, 'YYYY'), count(distinct REPORTS.USER_ID)
from REPORTS
group by TO_CHAR(REPORTS.DAT, 'YYYY')

select TO_CHAR(REPORTS.DAT, 'YYYY'), REPORTS.USER_ID, count(REPORTS.ID)
from REPORTS
group by TO_CHAR(REPORTS.DAT, 'YYYY'), REPORTS.USER_ID

select *
from  
(select OPERATIONS.REPORT_ID, count (OPERATIONS.ID)
from REPORTS
inner join OPERATIONS ON REPORTS.ID=OPERATIONS.REPORT_ID
where to_char(REPORTS.DAT, 'mm') = '04'
and to_char(REPORTS.DAT, 'yyyy') = '2018'
group by OPERATIONS.REPORT_ID
order by count (OPERATIONS.ID) desc)
where ROWNUM <= 1

select OPERATIONS.USER_ID, count (OPERATIONS.ID)
from REPORTS
inner join OPERATIONS ON REPORTS.ID=OPERATIONS.REPORT_ID
where to_char(REPORTS.DAT, 'yyyy') = '2018'
group by OPERATIONS.USER_ID

ROW_NUMBER()
   OVER (PARTITION BY OPERATIONS.USER_ID, count(OPERATIONS.ID) 
		 ORDER BY count(OPERATIONS.ID) desc) AS rating


РЕЙТИНГ ХРЕН ЗНАЕТ ЧЕГО ЧЕЛОВЕК-МЕСЯЦ______________________________________________________________
select 
OPERATIONS.USER_ID, 
to_char(REPORTS.DAT, 'MM.YYYY'), 
count(OPERATIONS.ID),
dense_rank()
   over (order by count(OPERATIONS.ID) desc) AS rating
from REPORTS
inner join OPERATIONS ON REPORTS.ID=OPERATIONS.REPORT_ID
where to_char(REPORTS.DAT, 'yyyy') = '2018'
group by OPERATIONS.USER_ID, to_char(REPORTS.DAT, 'MM.YYYY')
order by rating




РЕЙТИНГ ПО ПОЛЬЗОВАТЕЛЮ (ОБЩЕЕ КОЛИЧЕСТВО ПРОДАЖ)__________________________________________________
select 
OPERATIONS.USER_ID, 
to_char(REPORTS.DAT, 'MM.YYYY'), 
count(OPERATIONS.ID),
TEMP.RATING
from REPORTS
inner join OPERATIONS ON REPORTS.ID=OPERATIONS.REPORT_ID
inner join 
	(select 
	 OPERATIONS.USER_ID as USER_ID,
	 dense_rank() over (order by count(OPERATIONS.ID) desc) AS rating
	from REPORTS
	inner join OPERATIONS ON REPORTS.ID=OPERATIONS.REPORT_ID
	where to_char(REPORTS.DAT, 'yyyy') = '2018'
	group by OPERATIONS.USER_ID, to_char(REPORTS.DAT, 'YYYY')) TEMP
	on TEMP.USER_ID = OPERATIONS.USER_ID
where to_char(REPORTS.DAT, 'yyyy') = '2018'
group by OPERATIONS.USER_ID, to_char(REPORTS.DAT, 'MM.YYYY'), TEMP.RATING
order by rating

order by count(OPERATIONS.ID) desc



ТАБЛИЦА С МАКСИМАЛЬНЫМИ ЗНАЧЕНИЯМИ________________________________________________________________
select INTEMP.USER_ID AS USER_ID, max(INTEMP.OP_COUNT) AS MAX_COUNT, 
	  dense_rank() over (order by max(INTEMP.OP_COUNT) desc) AS 
	  from(select 
		OPERATIONS.USER_ID as USER_ID, 
		to_char(REPORTS.DAT, 'MM.YYYY') as MONTH, 
		count(OPERATIONS.ID)as OP_COUNT
		from REPORTS
		inner join OPERATIONS ON REPORTS.ID=OPERATIONS.REPORT_ID
		where to_char(REPORTS.DAT, 'yyyy') = '2018'
		group by OPERATIONS.USER_ID, to_char(REPORTS.DAT, 'MM.YYYY')) INTEMP
	  group by temp.USER_ID



САМЫЙ УДАЧНЫЙ МЕСЯЦ_______________________________________________________________________________
select COUNT_T.USER_ID, COUNT_T.MONTH, COUNT_T.OP_COUNT, MAX_T.RATING
from
	(select 
	OPERATIONS.USER_ID as USER_ID, 
	to_char(REPORTS.DAT, 'MM.YYYY') as MONTH, 
	count(OPERATIONS.ID) as OP_COUNT
	from REPORTS
	inner join OPERATIONS ON REPORTS.ID=OPERATIONS.REPORT_ID
	where to_char(REPORTS.DAT, 'yyyy') = '2018'
	group by OPERATIONS.USER_ID, to_char(REPORTS.DAT, 'MM.YYYY')) COUNT_T
inner join
	(select INTEMP.USER_ID AS USER_ID, max(INTEMP.OP_COUNT) AS MAX_COUNT, 
	  dense_rank() over (order by max(INTEMP.OP_COUNT) desc) AS RATING
	  from(select 
		OPERATIONS.USER_ID as USER_ID, 
		to_char(REPORTS.DAT, 'MM.YYYY') as MONTH, 
		count(OPERATIONS.ID)as OP_COUNT
		from REPORTS
		inner join OPERATIONS ON REPORTS.ID=OPERATIONS.REPORT_ID
		where to_char(REPORTS.DAT, 'yyyy') = '2018'
		group by OPERATIONS.USER_ID, to_char(REPORTS.DAT, 'MM.YYYY')) INTEMP
	  group by INTEMP.USER_ID) MAX_T
	on MAX_T.USER_ID=COUNT_T.USER_ID
where MAX_T.MAX_COUNT=COUNT_T.OP_COUNT
order by MAX_T.RATING





Определите рейтинг пользователей по количеству созданных операций в каждом из месяцев 2018 года. Выведите USER_ID, дату в формате (MM.YYYY), кол-во созданных операций, рейтинг пользователя (1,2 и так далее - без пропусков, пользователи, создавшие одинаковое количество операций имеют одинаковый рейтинг).

select 
OPERATIONS.USER_ID, 
to_char(REPORTS.DAT, 'MM.YYYY'), 
count(OPERATIONS.ID),
dense_rank()
   over (PARTITION BY to_char(REPORTS.DAT, 'MM.YYYY') order by count(OPERATIONS.ID) desc) AS rating
from REPORTS
inner join OPERATIONS ON REPORTS.ID=OPERATIONS.REPORT_ID
where to_char(REPORTS.DAT, 'yyyy') = '2018'
group by OPERATIONS.USER_ID, to_char(REPORTS.DAT, 'MM.YYYY')
order by to_char(REPORTS.DAT, 'MM.YYYY')

